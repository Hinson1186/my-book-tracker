<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBookTracker - 雲端書籍管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 書籍卡片動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .book-card {
            animation: fadeIn 0.3s ease-out forwards;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* 載入動畫 */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        /* 同步狀態指示器 */
        .sync-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .sync-status-indicator.connected {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }
        
        .sync-status-indicator.disconnected {
            background-color: #6b7280;
        }
        
        .sync-status-indicator.syncing {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        .sync-status-indicator.error {
            background-color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 同步通知 */
        .sync-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        
        .sync-notification.show {
            transform: translateY(0);
        }
        
        .sync-notification.success {
            background-color: #10b981;
        }
        
        .sync-notification.error {
            background-color: #ef4444;
        }
        
        .sync-notification.info {
            background-color: #3b82f6;
        }
        
        /* 分類樹狀結構 */
        .category-children {
            margin-left: 16px;
            border-left: 1px solid #e5e7eb;
            padding-left: 8px;
        }
        
        .category-toggle {
            transition: transform 0.2s ease;
        }
        
        /* 離線指示器 */
        .offline-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background-color: #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- 離線指示器 -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="fas fa-wifi-slash mr-2"></i>
        離線模式 - 變更將在重新連線後同步
        <span id="offlineOperationsCount" class="ml-2 bg-white text-orange-600 px-2 py-1 rounded-full text-xs hidden">0</span>
    </div>

    <!-- 主容器 -->
    <div class="min-h-screen flex flex-col">
        <!-- 標題列 -->
        <header class="bg-indigo-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-book-open text-2xl"></i>
                    <h1 class="text-2xl font-bold">MyBookTracker</h1>
                    <div class="ml-4 flex items-center text-sm">
                        <div id="syncStatusIndicator" class="sync-status-indicator disconnected"></div>
                        <span id="syncStatusText">初始化中...</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:block text-xs">
                        <div id="lastSyncTime">尚未同步</div>
                    </div>
                    <button id="mobileMenuBtn" class="md:hidden text-white p-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button id="addBookBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-full font-medium hover:bg-indigo-50 transition">
                        <i class="fas fa-plus mr-2"></i> 新增書籍
                    </button>
                    <button id="addByIsbnBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-full font-medium hover:bg-indigo-400 transition">
                        <i class="fas fa-barcode mr-2"></i> ISBN 搜尋
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要佈局 -->
        <div class="flex flex-grow">
            <!-- 側邊欄 -->
            <aside class="w-64 bg-white shadow-sm p-4 hidden md:block">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg text-gray-700">分類</h3>
                    <button id="manageCategoriesBtn" class="text-indigo-600 hover:text-indigo-800 text-sm">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <ul class="space-y-1" id="categoriesList">
                    <!-- 分類列表將動態生成 -->
                </ul>
            </aside>

            <!-- 主要內容 -->
            <main class="flex-grow container mx-auto px-4 py-6">
                <!-- 統計概覽 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                        <div class="bg-indigo-100 p-3 rounded-full mr-4">
                            <i class="fas fa-book text-indigo-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">總書籍數</p>
                            <p class="text-2xl font-bold" id="totalBooks">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-folder text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">分類數</p>
                            <p class="text-2xl font-bold" id="totalCategories">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4">
                            <i class="fas fa-cloud text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">同步狀態</p>
                            <p class="text-sm font-medium" id="syncStatusDisplay">檢查中...</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                        <div class="bg-purple-100 p-3 rounded-full mr-4">
                            <i class="fas fa-clock text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">最後更新</p>
                            <p class="text-sm font-medium" id="lastUpdateTime">-</p>
                        </div>
                    </div>
                </div>

                <!-- 搜尋和排序 -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input id="searchInput" type="text" placeholder="搜尋書籍..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-gray-600 text-sm">排序:</label>
                            <select id="sortSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="title-asc">書名 (A-Z)</option>
                                <option value="title-desc">書名 (Z-A)</option>
                                <option value="author-asc">作者 (A-Z)</option>
                                <option value="author-desc">作者 (Z-A)</option>
                                <option value="category-asc">分類 (A-Z)</option>
                                <option value="category-desc">分類 (Z-A)</option>
                                <option value="date-desc">最近新增</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 書籍網格 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">我的書籍</h2>
                        <div class="flex items-center space-x-2">
                            <button id="gridViewBtn" class="p-2 rounded-lg bg-indigo-100 text-indigo-600">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button id="listViewBtn" class="p-2 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 載入指示器 -->
                    <div id="loadingIndicator" class="flex justify-center items-center py-8">
                        <div class="spinner"></div>
                        <span class="ml-2 text-gray-600">載入書籍中...</span>
                    </div>

                    <!-- 空狀態 -->
                    <div id="emptyState" class="hidden text-center py-12">
                        <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">還沒有書籍</h3>
                        <p class="text-gray-500 mb-4">開始建立您的數位圖書館吧！</p>
                        <button class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition" onclick="openAddBookModal()">
                            <i class="fas fa-plus mr-2"></i> 新增第一本書
                        </button>
                    </div>

                    <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- 書籍卡片將動態插入這裡 -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 新增書籍模態框 -->
    <div id="addBookModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">新增書籍</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="addBookForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookTitle">書名</label>
                        <input type="text" id="bookTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookAuthor">作者</label>
                        <input type="text" id="bookAuthor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookCategory">分類</label>
                        <select id="bookCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="uncategorized">未分類</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookCover">封面網址</label>
                        <input type="text" id="bookCover" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://example.com/book-cover.jpg">
                    </div>
                </form>
            </div>
            <div class="flex justify-end border-t px-6 py-4 space-x-3">
                <button id="cancelAddBookBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">取消</button>
                <button id="saveBookBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <span id="saveBookText">儲存書籍</span>
                    <div id="saveBookSpinner" class="hidden ml-2 spinner"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ISBN 搜尋模態框 -->
    <div id="addByIsbnModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">ISBN 搜尋書籍</h3>
                <button id="closeIsbnModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="isbnInput">ISBN</label>
                    <input type="text" id="isbnInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="輸入 ISBN (10 或 13 位數字)">
                </div>
                <div id="bookPreview" class="hidden mb-4 p-4 border border-gray-200 rounded-lg">
                    <div class="flex gap-4">
                        <img id="previewCover" src="" alt="書籍封面" class="w-16 h-24 object-cover rounded">
                        <div>
                            <h4 id="previewTitle" class="font-semibold"></h4>
                            <p id="previewAuthor" class="text-gray-600 text-sm"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end border-t px-6 py-4 space-x-3">
                <button id="cancelIsbnBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">取消</button>
                <button id="searchIsbnBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <span id="searchIsbnText">搜尋</span>
                    <div id="searchIsbnSpinner" class="hidden ml-2 spinner"></div>
                </button>
                <button id="addFromIsbnBtn" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">新增書籍</button>
            </div>
        </div>
    </div>

    <!-- 書籍詳情模態框 -->
    <div id="bookDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">書籍詳情</h3>
                <button id="closeDetailsModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex flex-col md:flex-row gap-6 mb-6">
                    <div class="flex-shrink-0">
                        <img id="detailsBookCover" src="https://via.placeholder.com/150x200" alt="書籍封面" class="w-32 h-48 object-cover rounded-lg shadow-sm">
                    </div>
                    <div>
                        <h2 id="detailsBookTitle" class="text-2xl font-bold mb-1">書名</h2>
                        <p id="detailsBookAuthor" class="text-gray-600 mb-3">作者</p>
                        <p id="detailsBookCategory" class="text-sm text-indigo-600 mb-3">分類</p>
                        <div class="flex space-x-2">
                            <button id="editBookBtn" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50">
                                <i class="fas fa-edit mr-1"></i> 編輯
                            </button>
                            <button id="deleteBookBtn" class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-red-50 text-red-600">
                                <i class="fas fa-trash mr-1"></i> 刪除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分類管理模態框 -->
    <div id="manageCategoriesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">管理分類</h3>
                <button id="closeCategoriesModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="mb-6">
                    <h4 class="font-semibold mb-3">分類結構</h4>
                    <div id="categoryTreeContainer" class="border border-gray-200 rounded-lg p-4 min-h-[200px]">
                        <!-- 分類樹將動態生成 -->
                    </div>
                </div>
                
                <div class="border-t pt-6">
                    <h4 class="font-semibold mb-3">新增分類</h4>
                    <form id="addCategoryForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2" for="categoryName">分類名稱</label>
                                <input type="text" id="categoryName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2" for="parentCategory">父分類</label>
                                <select id="parentCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">根層級</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="submit" id="addCategoryBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>新增分類</span>
                                <div id="addCategorySpinner" class="hidden ml-2 spinner"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入 Firebase 模組 -->
    <script src="firebase-integration.js"></script>
    <script src="firebase-book-operations.js"></script>
    <script src="firebase-category-operations.js"></script>
    <script src="firebase-realtime-sync.js"></script>

    <script>
        // 全域變數
        let currentView = "grid";
        let currentSelectedBook = null;
        let currentCategory = "all";
        let foundBookData = null;

        // DOM 元素
        const booksContainer = document.getElementById("booksContainer");
        const addBookBtn = document.getElementById("addBookBtn");
        const addByIsbnBtn = document.getElementById("addByIsbnBtn");
        const addBookModal = document.getElementById("addBookModal");
        const addByIsbnModal = document.getElementById("addByIsbnModal");
        const bookDetailsModal = document.getElementById("bookDetailsModal");
        const manageCategoriesModal = document.getElementById("manageCategoriesModal");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const emptyState = document.getElementById("emptyState");
        const offlineIndicator = document.getElementById("offlineIndicator");

        // 初始化應用程式
        function init() {
            setupEventListeners();
            setupSyncStatusListener();
            
            // 初始 UI 狀態
            hideLoading();
        }

        // 設置事件監聽器
        function setupEventListeners() {
            // 書籍相關
            addBookBtn.addEventListener("click", openAddBookModal);
            addByIsbnBtn.addEventListener("click", openAddByIsbnModal);
            document.getElementById("closeModalBtn").addEventListener("click", closeAddBookModal);
            document.getElementById("closeIsbnModalBtn").addEventListener("click", closeAddByIsbnModal);
            document.getElementById("closeDetailsModalBtn").addEventListener("click", closeBookDetailsModal);
            document.getElementById("cancelAddBookBtn").addEventListener("click", closeAddBookModal);
            document.getElementById("cancelIsbnBtn").addEventListener("click", closeAddByIsbnModal);
            document.getElementById("saveBookBtn").addEventListener("click", saveBook);
            document.getElementById("searchIsbnBtn").addEventListener("click", searchByISBN);
            document.getElementById("addFromIsbnBtn").addEventListener("click", addBookFromISBN);
            document.getElementById("deleteBookBtn").addEventListener("click", deleteBook);

            // 分類管理
            document.getElementById("manageCategoriesBtn").addEventListener("click", openManageCategoriesModal);
            document.getElementById("closeCategoriesModalBtn").addEventListener("click", closeManageCategoriesModal);
            document.getElementById("addCategoryForm").addEventListener("submit", addCategory);

            // 視圖切換
            document.getElementById("gridViewBtn").addEventListener("click", () => setView("grid"));
            document.getElementById("listViewBtn").addEventListener("click", () => setView("list"));

            // 搜尋和排序
            document.getElementById("searchInput").addEventListener("input", renderBooks);
            document.getElementById("sortSelect").addEventListener("change", renderBooks);

            // 手機選單
            document.getElementById("mobileMenuBtn").addEventListener("click", toggleMobileMenu);

            // ISBN 輸入 Enter 鍵支援
            document.getElementById("isbnInput").addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    searchByISBN();
                }
            });
        }

        // 設置同步狀態監聽器
        function setupSyncStatusListener() {
            if (window.firebaseRealtimeSync) {
                window.firebaseRealtimeSync.addSyncStatusListener((status, message) => {
                    updateSyncStatusDisplay(status, message);
                    
                    // 更新離線指示器
                    if (status === 'disconnected') {
                        offlineIndicator.classList.add('show');
                    } else {
                        offlineIndicator.classList.remove('show');
                    }
                });
            }
        }

        // 更新同步狀態顯示
        function updateSyncStatusDisplay(status, message) {
            const syncStatusDisplay = document.getElementById('syncStatusDisplay');
            const lastUpdateTime = document.getElementById('lastUpdateTime');
            
            if (syncStatusDisplay) {
                switch (status) {
                    case 'connected':
                        syncStatusDisplay.textContent = '已連線';
                        syncStatusDisplay.className = 'text-sm font-medium text-green-600';
                        break;
                    case 'disconnected':
                        syncStatusDisplay.textContent = '離線';
                        syncStatusDisplay.className = 'text-sm font-medium text-gray-600';
                        break;
                    case 'syncing':
                        syncStatusDisplay.textContent = '同步中';
                        syncStatusDisplay.className = 'text-sm font-medium text-yellow-600';
                        break;
                    case 'error':
                        syncStatusDisplay.textContent = '錯誤';
                        syncStatusDisplay.className = 'text-sm font-medium text-red-600';
                        break;
                }
            }
            
            if (lastUpdateTime && status === 'connected') {
                lastUpdateTime.textContent = new Date().toLocaleTimeString();
            }
        }

        // 渲染書籍
        function renderBooks() {
            hideLoading();
            booksContainer.innerHTML = "";
            
            const books = window.firebaseBookOperations ? window.firebaseBookOperations.getBooks() : [];
            
            if (books.length === 0) {
                emptyState.classList.remove("hidden");
                return;
            } else {
                emptyState.classList.add("hidden");
            }
            
            const filteredBooks = filterAndSortBooks(books);
            
            filteredBooks.forEach(book => {
                const bookCard = createBookCard(book);
                booksContainer.appendChild(bookCard);
            });
        }

        // 篩選和排序書籍
        function filterAndSortBooks(books) {
            let filteredBooks = [...books];
            const searchTerm = document.getElementById("searchInput").value.toLowerCase();
            const sortOption = document.getElementById("sortSelect").value;
            
            // 應用分類篩選
            if (currentCategory !== "all") {
                const categories = window.firebaseCategoryOperations ? window.firebaseCategoryOperations.getCategories() : [];
                
                if (currentCategory === "uncategorized") {
                    filteredBooks = filteredBooks.filter(book => 
                        !book.category || book.category === "uncategorized"
                    );
                } else {
                    // 包含子分類
                    const subCategoryIds = window.firebaseCategoryOperations ? 
                        window.firebaseCategoryOperations.getAllSubCategoryIds(currentCategory) : [];
                    const allCategoryIds = [currentCategory, ...subCategoryIds];
                    
                    filteredBooks = filteredBooks.filter(book => 
                        allCategoryIds.includes(book.category)
                    );
                }
            }
            
            // 應用搜尋篩選
            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) || 
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.category && getCategoryPath(book.category).toLowerCase().includes(searchTerm))
                );
            }
            
            // 應用排序
            switch(sortOption) {
                case "title-asc":
                    filteredBooks.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case "title-desc":
                    filteredBooks.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case "author-asc":
                    filteredBooks.sort((a, b) => a.author.localeCompare(b.author));
                    break;
                case "author-desc":
                    filteredBooks.sort((a, b) => b.author.localeCompare(a.author));
                    break;
                case "category-asc":
                    filteredBooks.sort((a, b) => getCategoryPath(a.category).localeCompare(getCategoryPath(b.category)));
                    break;
                case "category-desc":
                    filteredBooks.sort((a, b) => getCategoryPath(b.category).localeCompare(getCategoryPath(a.category)));
                    break;
                case "date-desc":
                    filteredBooks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
            }
            
            return filteredBooks;
        }

        // 獲取分類路徑
        function getCategoryPath(categoryId) {
            if (!categoryId || categoryId === 'uncategorized') return '未分類';
            
            if (window.firebaseCategoryOperations) {
                return window.firebaseCategoryOperations.getCategoryFullPath(categoryId) || categoryId;
            }
            
            return categoryId;
        }

        // 創建書籍卡片
        function createBookCard(book) {
            const bookCard = document.createElement("div");
            bookCard.className = `book-card bg-white rounded-lg shadow-sm overflow-hidden cursor-pointer ${currentView === "grid" ? "" : "flex"}`;
            bookCard.dataset.id = book.id;
            
            const categoryPath = getCategoryPath(book.category);
            const categoryColor = window.firebaseCategoryOperations ? 
                window.firebaseCategoryOperations.getCategoryColor({ name: categoryPath }) : '#6b7280';
            
            if (currentView === "grid") {
                bookCard.innerHTML = `
                    <div class="relative">
                        <img src="${book.cover || "https://via.placeholder.com/300x450?text=No+Cover"}" alt="${book.title}" class="w-full h-48 object-cover">
                        <span class="absolute top-2 right-2 px-2 py-1 text-xs rounded-full text-white" style="background-color: ${categoryColor}">${categoryPath}</span>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-1 truncate">${book.title}</h3>
                        <p class="text-gray-600 text-sm mb-3 truncate">${book.author}</p>
                    </div>
                `;
            } else {
                bookCard.innerHTML = `
                    <div class="flex-shrink-0">
                        <img src="${book.cover || "https://via.placeholder.com/300x450?text=No+Cover"}" alt="${book.title}" class="w-24 h-36 object-cover">
                    </div>
                    <div class="p-4 flex-grow">
                        <div class="flex justify-between">
                            <div>
                                <h3 class="font-semibold text-lg mb-1">${book.title}</h3>
                                <p class="text-gray-600 text-sm mb-2">${book.author}</p>
                                <span class="px-2 py-1 text-xs rounded-full text-white" style="background-color: ${categoryColor}">${categoryPath}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加點擊事件
            bookCard.addEventListener("click", () => {
                openBookDetails(book.id);
            });
            
            return bookCard;
        }

        // 更新統計
        function updateStats() {
            const books = window.firebaseBookOperations ? window.firebaseBookOperations.getBooks() : [];
            const categories = window.firebaseCategoryOperations ? window.firebaseCategoryOperations.getCategories() : [];
            
            document.getElementById("totalBooks").textContent = books.length;
            document.getElementById("totalCategories").textContent = categories.length;
        }

        // 模態框操作
        function openAddBookModal() {
            addBookModal.classList.remove("hidden");
        }

        function closeAddBookModal() {
            addBookModal.classList.add("hidden");
            document.getElementById("addBookForm").reset();
        }

        function openAddByIsbnModal() {
            addByIsbnModal.classList.remove("hidden");
            document.getElementById("bookPreview").classList.add("hidden");
            document.getElementById("addFromIsbnBtn").classList.add("hidden");
            foundBookData = null;
        }

        function closeAddByIsbnModal() {
            addByIsbnModal.classList.add("hidden");
            document.getElementById("isbnInput").value = "";
            document.getElementById("bookPreview").classList.add("hidden");
            document.getElementById("addFromIsbnBtn").classList.add("hidden");
            foundBookData = null;
        }

        function openBookDetails(bookId) {
            const books = window.firebaseBookOperations ? window.firebaseBookOperations.getBooks() : [];
            const book = books.find(b => b.id === bookId);
            if (!book) return;
            
            currentSelectedBook = book;
            
            document.getElementById("detailsBookTitle").textContent = book.title;
            document.getElementById("detailsBookAuthor").textContent = book.author;
            document.getElementById("detailsBookCategory").textContent = getCategoryPath(book.category);
            document.getElementById("detailsBookCover").src = book.cover || "https://via.placeholder.com/300x450?text=No+Cover";
            
            bookDetailsModal.classList.remove("hidden");
        }

        function closeBookDetailsModal() {
            bookDetailsModal.classList.add("hidden");
            currentSelectedBook = null;
        }

        function openManageCategoriesModal() {
            manageCategoriesModal.classList.remove("hidden");
            renderCategoryManagement();
        }

        function closeManageCategoriesModal() {
            manageCategoriesModal.classList.add("hidden");
        }

        // 書籍操作
        async function saveBook() {
            const title = document.getElementById("bookTitle").value.trim();
            const author = document.getElementById("bookAuthor").value.trim();
            const category = document.getElementById("bookCategory").value;
            const cover = document.getElementById("bookCover").value.trim();
            
            if (!title || !author) {
                showToast("請填寫所有必填欄位", "error");
                return;
            }

            const saveBtn = document.getElementById("saveBookBtn");
            const saveText = document.getElementById("saveBookText");
            const saveSpinner = document.getElementById("saveBookSpinner");
            
            saveText.textContent = "儲存中...";
            saveSpinner.classList.remove("hidden");
            saveBtn.disabled = true;
            
            try {
                await window.addBookToFirestore({
                    title,
                    author,
                    category,
                    cover: cover || null
                });
                closeAddBookModal();
            } catch (error) {
                console.error('儲存書籍失敗:', error);
            } finally {
                saveText.textContent = "儲存書籍";
                saveSpinner.classList.add("hidden");
                saveBtn.disabled = false;
            }
        }

        async function searchByISBN() {
            const isbn = document.getElementById("isbnInput").value.trim();
            if (!isbn) {
                showToast("請輸入 ISBN", "error");
                return;
            }

            const searchBtn = document.getElementById("searchIsbnBtn");
            const searchText = document.getElementById("searchIsbnText");
            const searchSpinner = document.getElementById("searchIsbnSpinner");
            
            searchText.textContent = "搜尋中...";
            searchSpinner.classList.remove("hidden");
            searchBtn.disabled = true;

            try {
                const bookData = await window.searchBookByISBN(isbn);
                foundBookData = bookData;
                
                document.getElementById("previewTitle").textContent = bookData.title;
                document.getElementById("previewAuthor").textContent = bookData.author;
                document.getElementById("previewCover").src = bookData.cover || "https://via.placeholder.com/150x200?text=No+Cover";
                document.getElementById("bookPreview").classList.remove("hidden");
                document.getElementById("addFromIsbnBtn").classList.remove("hidden");
                
                showToast("找到書籍！", "success");
            } catch (error) {
                showToast("找不到書籍，請檢查 ISBN", "error");
            } finally {
                searchText.textContent = "搜尋";
                searchSpinner.classList.add("hidden");
                searchBtn.disabled = false;
            }
        }

        async function addBookFromISBN() {
            if (!foundBookData) return;

            try {
                await window.addBookToFirestore({
                    title: foundBookData.title,
                    author: foundBookData.author,
                    cover: foundBookData.cover,
                    category: "uncategorized",
                    isbn: foundBookData.isbn
                });
                closeAddByIsbnModal();
            } catch (error) {
                console.error('新增書籍失敗:', error);
            }
        }

        async function deleteBook() {
            if (!currentSelectedBook) return;
            
            try {
                await window.deleteBookFromFirestore(currentSelectedBook.id);
                closeBookDetailsModal();
            } catch (error) {
                console.error('刪除書籍失敗:', error);
            }
        }

        // 分類操作
        async function addCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById("categoryName").value.trim();
            const parentId = document.getElementById("parentCategory").value || null;
            
            if (!name) {
                showToast("請輸入分類名稱", "error");
                return;
            }

            const addBtn = document.getElementById("addCategoryBtn");
            const addSpinner = document.getElementById("addCategorySpinner");
            
            addSpinner.classList.remove("hidden");
            addBtn.disabled = true;
            
            try {
                if (window.firebaseCategoryOperations) {
                    await window.firebaseCategoryOperations.addHierarchicalCategory({
                        name,
                        parentId,
                        description: `用戶創建的 ${name} 分類`
                    });
                }
                
                document.getElementById("addCategoryForm").reset();
                renderCategoryManagement();
            } catch (error) {
                console.error('新增分類失敗:', error);
            } finally {
                addSpinner.classList.add("hidden");
                addBtn.disabled = false;
            }
        }

        // 渲染分類管理
        function renderCategoryManagement() {
            // 更新父分類選擇器
            const parentSelect = document.getElementById("parentCategory");
            const categories = window.firebaseCategoryOperations ? window.firebaseCategoryOperations.getCategories() : [];
            
            parentSelect.innerHTML = '<option value="">根層級</option>';
            
            categories.forEach(category => {
                if (category.id !== 'uncategorized') {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.path || category.name;
                    parentSelect.appendChild(option);
                }
            });
            
            // 渲染分類樹
            const treeContainer = document.getElementById("categoryTreeContainer");
            if (window.firebaseCategoryOperations) {
                const categoryTree = window.firebaseCategoryOperations.buildCategoryTree();
                treeContainer.innerHTML = renderCategoryTree(categoryTree);
            }
        }

        function renderCategoryTree(categories) {
            if (!categories || categories.length === 0) {
                return '<p class="text-gray-500 text-center py-4">尚無分類</p>';
            }
            
            return categories.map(category => `
                <div class="category-item mb-2">
                    <div class="flex items-center justify-between p-2 border border-gray-200 rounded">
                        <div class="flex items-center">
                            <i class="fas ${window.firebaseCategoryOperations.getCategoryIcon(category)} mr-2" 
                               style="color: ${window.firebaseCategoryOperations.getCategoryColor(category)}"></i>
                            <span class="font-medium">${category.name}</span>
                            <span class="ml-2 text-xs text-gray-500">(${category.path})</span>
                        </div>
                        <div class="flex space-x-1">
                            <button class="text-red-600 hover:text-red-800 text-sm p-1" 
                                    onclick="deleteCategory('${category.id}')" 
                                    title="刪除分類">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${category.children && category.children.length > 0 ? 
                        `<div class="ml-4 mt-2">${renderCategoryTree(category.children)}</div>` : ''}
                </div>
            `).join('');
        }

        async function deleteCategory(categoryId) {
            if (window.firebaseCategoryOperations) {
                try {
                    await window.firebaseCategoryOperations.deleteHierarchicalCategory(categoryId);
                    renderCategoryManagement();
                } catch (error) {
                    console.error('刪除分類失敗:', error);
                }
            }
        }

        // 視圖切換
        function setView(view) {
            if (currentView !== view) {
                currentView = view;
                
                const gridBtn = document.getElementById("gridViewBtn");
                const listBtn = document.getElementById("listViewBtn");
                
                if (view === "grid") {
                    gridBtn.classList.add("bg-indigo-100", "text-indigo-600");
                    gridBtn.classList.remove("hover:bg-gray-100");
                    listBtn.classList.remove("bg-indigo-100", "text-indigo-600");
                    listBtn.classList.add("hover:bg-gray-100");
                } else {
                    listBtn.classList.add("bg-indigo-100", "text-indigo-600");
                    listBtn.classList.remove("hover:bg-gray-100");
                    gridBtn.classList.remove("bg-indigo-100", "text-indigo-600");
                    gridBtn.classList.add("hover:bg-gray-100");
                }
                
                renderBooks();
            }
        }

        // 設置當前分類
        function setCurrentCategory(categoryId) {
            currentCategory = categoryId;
            renderBooks();
        }

        // 切換手機選單
        function toggleMobileMenu() {
            const sidebar = document.querySelector("aside");
            sidebar.classList.toggle("hidden");
        }

        // 隱藏載入指示器
        function hideLoading() {
            loadingIndicator.classList.add("hidden");
        }

        // 顯示 Toast 通知
        function showToast(message, type = 'success') {
            if (window.firebaseBookOperations) {
                window.firebaseBookOperations.showToast(message, type);
            }
        }

        // 全域函式
        window.openAddBookModal = openAddBookModal;
        window.renderBooks = renderBooks;
        window.updateStats = updateStats;
        window.setCurrentCategory = setCurrentCategory;
        window.deleteCategory = deleteCategory;

        // 初始化應用程式
        document.addEventListener("DOMContentLoaded", init);

        // 定期更新統計和 UI
        setInterval(() => {
            updateStats();
            if (window.firebaseCategoryOperations) {
                window.firebaseCategoryOperations.updateCategoryBookCounts();
                window.firebaseCategoryOperations.updateCategorySelectors();
            }
        }, 5000);
    </script>
</body>
</html>

