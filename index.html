<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBookTracker - 雲端書籍管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 書籍卡片動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .book-card {
            animation: fadeIn 0.3s ease-out forwards;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* 載入動畫 */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background-color: #10b981;
        }
        
        .toast.error {
            background-color: #ef4444;
        }
        
        /* 分類樹狀結構 */
        .category-children {
            margin-left: 16px;
            border-left: 1px solid #e5e7eb;
            padding-left: 8px;
        }
        
        .category-toggle {
            transition: transform 0.2s ease;
        }
        
        /* 離線指示器 */
        .offline-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background-color: #f59e0b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- 離線指示器 -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="fas fa-wifi-slash mr-2"></i>
        離線模式 - 變更將在重新連線後同步
        <span id="offlineOperationsCount" class="ml-2 bg-white text-orange-600 px-2 py-1 rounded-full text-xs hidden">0</span>
    </div>

    <!-- 主容器 -->
    <div class="min-h-screen flex flex-col">
        <!-- 標題列 -->
        <header class="bg-indigo-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-book-open text-2xl"></i>
                        <h1 class="text-2xl font-bold">MyBookTracker</h1>
                    </div>
                    <div class="flex items-center space-x-2 bg-indigo-500 px-3 py-1 rounded-full">
                        <i class="fas fa-book text-sm"></i>
                        <span class="text-sm font-medium">總書籍數: <span id="totalBooks">0</span></span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="mobileMenuBtn" class="md:hidden text-white p-2">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button id="addBookBtn" class="bg-white text-indigo-600 px-4 py-2 rounded-full font-medium hover:bg-indigo-50 transition">
                        <i class="fas fa-plus mr-2"></i> 新增書籍
                    </button>
                    <button id="addByIsbnBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-full font-medium hover:bg-indigo-400 transition">
                        <i class="fas fa-barcode mr-2"></i> ISBN 搜尋
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要佈局 -->
        <div class="flex flex-grow">
            <!-- 側邊欄 -->
            <aside class="w-64 bg-white shadow-sm p-4 hidden md:block">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg text-gray-700">分類</h3>
                    <button id="manageCategoriesBtn" class="text-indigo-600 hover:text-indigo-800 text-sm">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <ul class="space-y-1" id="categoriesList">
                    <!-- 分類列表將動態生成 -->
                </ul>
            </aside>

            <!-- 主要內容 -->
            <main class="flex-grow container mx-auto px-4 py-6">
                <!-- 搜尋和排序 -->
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="relative flex-grow">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input id="searchInput" type="text" placeholder="搜尋書籍..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-gray-600 text-sm">排序:</label>
                            <select id="sortSelect" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="title-asc">書名 (A-Z)</option>
                                <option value="title-desc">書名 (Z-A)</option>
                                <option value="author-asc">作者 (A-Z)</option>
                                <option value="author-desc">作者 (Z-A)</option>
                                <option value="category-asc">分類 (A-Z)</option>
                                <option value="category-desc">分類 (Z-A)</option>
                                <option value="date-desc">最近新增</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 書籍網格 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">我的書籍</h2>
                        <div class="flex items-center space-x-2">
                            <button id="gridViewBtn" class="p-2 rounded-lg bg-indigo-100 text-indigo-600">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button id="listViewBtn" class="p-2 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 載入指示器 -->
                    <div id="loadingIndicator" class="flex justify-center items-center py-8">
                        <div class="spinner"></div>
                        <span class="ml-2 text-gray-600">載入書籍中...</span>
                    </div>

                    <!-- 空狀態 -->
                    <div id="emptyState" class="hidden text-center py-12">
                        <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">還沒有書籍</h3>
                        <p class="text-gray-500 mb-4">開始建立您的數位圖書館吧！</p>
                        <button class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition" onclick="openAddBookModal()">
                            <i class="fas fa-plus mr-2"></i> 新增第一本書
                        </button>
                    </div>

                    <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- 書籍卡片將動態插入這裡 -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 新增書籍模態框 -->
    <div id="addBookModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">新增書籍</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="addBookForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookTitle">書名</label>
                        <input type="text" id="bookTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookAuthor">作者</label>
                        <input type="text" id="bookAuthor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookCategory">分類</label>
                        <select id="bookCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="uncategorized">未分類</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="bookCover">封面網址</label>
                        <input type="text" id="bookCover" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://example.com/book-cover.jpg">
                    </div>
                </form>
            </div>
            <div class="flex justify-end border-t px-6 py-4 space-x-3">
                <button id="cancelAddBookBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">取消</button>
                <button id="saveBookBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <span id="saveBookText">儲存書籍</span>
                    <div id="saveBookSpinner" class="hidden ml-2 spinner"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ISBN 搜尋模態框 -->
    <div id="addByIsbnModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">ISBN 搜尋書籍</h3>
                <button id="closeIsbnModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="isbnInput">ISBN</label>
                    <input type="text" id="isbnInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="請輸入 ISBN 號碼">
                </div>
                <div id="isbnSearchResults" class="mb-4 hidden">
                    <h4 class="font-semibold mb-2">搜尋結果:</h4>
                    <div id="isbnBookDetails" class="bg-gray-50 p-4 rounded-lg flex items-center">
                        <img id="isbnBookCover" src="" alt="Book Cover" class="w-24 h-32 object-cover rounded-md mr-4">
                        <div>
                            <p class="font-bold text-lg" id="isbnBookTitle"></p>
                            <p class="text-gray-600" id="isbnBookAuthor"></p>
                            <p class="text-gray-500 text-sm" id="isbnBookCategory"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end border-t px-6 py-4 space-x-3">
                <button id="cancelIsbnSearchBtn" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">取消</button>
                <button id="searchIsbnBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <span id="searchIsbnText">搜尋</span>
                    <div id="searchIsbnSpinner" class="hidden ml-2 spinner"></div>
                </button>
                <button id="addFoundBookBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">
                    <i class="fas fa-plus mr-2"></i> 新增此書
                </button>
            </div>
        </div>
    </div>

    <!-- 管理分類模態框 -->
    <div id="manageCategoriesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-xl font-semibold">管理分類</h3>
                <button id="closeManageCategoriesModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="newCategoryName">新增分類</label>
                    <div class="flex space-x-2">
                        <input type="text" id="newCategoryName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="分類名稱">
                        <button id="addCategoryBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">現有分類</label>
                    <ul id="manageCategoriesList" class="border border-gray-300 rounded-lg p-2 max-h-60 overflow-y-auto">
                        <!-- 分類列表將動態生成 -->
                    </ul>
                </div>
            </div>
            <div class="flex justify-end border-t px-6 py-4">
                <button id="saveCategoriesBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">完成</button>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <script type="module">
        // Firebase Configuration (請替換為您的實際配置)
        const firebaseConfig = {
            apiKey: "AIzaSyBhufd0TSjVN-6UZX0mjjNwozPma1KjiLw",
            authDomain: "booktracker-eeb80.firebaseapp.com",
            projectId: "booktracker-eeb80",
            storageBucket: "booktracker-eeb80.firebasestorage.app",
            messagingSenderId: "1041414142866",
            appId: "1:1041414142866:web:e1a396ed381137fab55f4b",
            measurementId: "G-ZRHGTERX9B"
        };

        // Google Books API Key (如果需要使用 Google Books API 進行 ISBN 搜尋)
        const GOOGLE_BOOKS_API_KEY = ""; // 請在此處填入您的 Google Books API 金鑰

        // Firebase SDK 導入
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, writeBatch, serverTimestamp, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // 初始化 Firebase (不使用 Authentication)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 全域變數
        let allBooks = [];
        let allCategories = [];
        let currentFilterCategory = null;
        let currentSortOrder = "date-desc";
        let currentViewMode = "grid"; // "grid" or "list"
        let isSyncing = false;
        let offlineOperations = [];

        // 使用固定的用戶ID (不需要 Authentication)
        const FIXED_USER_ID = "default_user";

        // UI 元素
        const addBookBtn = document.getElementById("addBookBtn");
        const addByIsbnBtn = document.getElementById("addByIsbnBtn");
        const manageCategoriesBtn = document.getElementById("manageCategoriesBtn");
        const searchInput = document.getElementById("searchInput");
        const sortSelect = document.getElementById("sortSelect");
        const booksContainer = document.getElementById("booksContainer");
        const categoriesList = document.getElementById("categoriesList");
        const totalBooksSpan = document.getElementById("totalBooks");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const emptyState = document.getElementById("emptyState");
        const toastElement = document.getElementById("toast");
        const offlineIndicator = document.getElementById("offlineIndicator");
        const offlineOperationsCountSpan = document.getElementById("offlineOperationsCount");
        const gridViewBtn = document.getElementById("gridViewBtn");
        const listViewBtn = document.getElementById("listViewBtn");

        // 新增書籍模態框元素
        const addBookModal = document.getElementById("addBookModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const addBookForm = document.getElementById("addBookForm");
        const bookTitleInput = document.getElementById("bookTitle");
        const bookAuthorInput = document.getElementById("bookAuthor");
        const bookCategorySelect = document.getElementById("bookCategory");
        const bookCoverInput = document.getElementById("bookCover");
        const cancelAddBookBtn = document.getElementById("cancelAddBookBtn");
        const saveBookBtn = document.getElementById("saveBookBtn");
        const saveBookText = document.getElementById("saveBookText");
        const saveBookSpinner = document.getElementById("saveBookSpinner");

        // ISBN 搜尋模態框元素
        const addByIsbnModal = document.getElementById("addByIsbnModal");
        const closeIsbnModalBtn = document.getElementById("closeIsbnModalBtn");
        const isbnInput = document.getElementById("isbnInput");
        const searchIsbnBtn = document.getElementById("searchIsbnBtn");
        const searchIsbnText = document.getElementById("searchIsbnText");
        const searchIsbnSpinner = document.getElementById("searchIsbnSpinner");
        const isbnSearchResults = document.getElementById("isbnSearchResults");
        const isbnBookCover = document.getElementById("isbnBookCover");
        const isbnBookTitle = document.getElementById("isbnBookTitle");
        const isbnBookAuthor = document.getElementById("isbnBookAuthor");
        const isbnBookCategory = document.getElementById("isbnBookCategory");
        const addFoundBookBtn = document.getElementById("addFoundBookBtn");
        const cancelIsbnSearchBtn = document.getElementById("cancelIsbnSearchBtn");

        // 管理分類模態框元素
        const manageCategoriesModal = document.getElementById("manageCategoriesModal");
        const closeManageCategoriesModalBtn = document.getElementById("closeManageCategoriesModalBtn");
        const newCategoryNameInput = document.getElementById("newCategoryName");
        const addCategoryBtn = document.getElementById("addCategoryBtn");
        const manageCategoriesList = document.getElementById("manageCategoriesList");
        const saveCategoriesBtn = document.getElementById("saveCategoriesBtn");

        // ==================== UI 輔助函數 ====================

        function showToast(message, type = "info") {
            toastElement.textContent = message;
            toastElement.className = `toast show ${type}`;
            setTimeout(() => {
                toastElement.classList.remove("show");
                // 完全隱藏通知，確保不會留在頁面上
                setTimeout(() => {
                    toastElement.style.display = 'none';
                }, 300); // 等待動畫完成後隱藏
            }, 2000); // 縮短顯示時間到 2 秒
            
            // 顯示時確保元素可見
            toastElement.style.display = 'block';
        }

        function updateOfflineOperationsCount(count) {
            if (count > 0) {
                offlineOperationsCountSpan.textContent = count;
                offlineOperationsCountSpan.classList.remove("hidden");
            } else {
                offlineOperationsCountSpan.classList.add("hidden");
            }
        }

        function toggleOfflineIndicator(show) {
            if (show) {
                offlineIndicator.classList.add("show");
            } else {
                offlineIndicator.classList.remove("show");
            }
        }

        function showLoading() {
            loadingIndicator.classList.remove("hidden");
            booksContainer.classList.add("hidden");
            emptyState.classList.add("hidden");
        }

        function hideLoading() {
            loadingIndicator.classList.add("hidden");
        }

        function showEmptyState() {
            emptyState.classList.remove("hidden");
            booksContainer.classList.add("hidden");
        }

        function hideEmptyState() {
            emptyState.classList.add("hidden");
            booksContainer.classList.remove("hidden");
        }

        // ==================== Firebase 整合邏輯 ====================

        // 添加離線操作
        function addOfflineOperation(operation) {
            offlineOperations.push(operation);
            localStorage.setItem("offlineOperations", JSON.stringify(offlineOperations));
            updateOfflineOperationsCount(offlineOperations.length);
            showToast("變更已儲存至離線佇列", "info");
        }

        // 同步離線操作
        async function syncOfflineOperations() {
            if (isSyncing || !navigator.onLine) {
                return;
            }

            isSyncing = true;

            const storedOperations = JSON.parse(localStorage.getItem("offlineOperations") || "[]");
            offlineOperations = storedOperations;
            updateOfflineOperationsCount(offlineOperations.length);

            if (offlineOperations.length === 0) {
                isSyncing = false;
                return;
            }

            const batch = writeBatch(db);
            let hasError = false;

            for (const op of offlineOperations) {
                try {
                    const docRef = op.collection === "books" ? doc(db, `users/${FIXED_USER_ID}/books`, op.id) : doc(db, `users/${FIXED_USER_ID}/categories`, op.id);
                    switch (op.type) {
                        case "add":
                            const existingDoc = await getDoc(docRef);
                            if (existingDoc.exists()) {
                                batch.update(docRef, op.data);
                            } else {
                                batch.set(docRef, op.data);
                            }
                            break;
                        case "update":
                            batch.update(docRef, op.data);
                            break;
                        case "delete":
                            batch.delete(docRef);
                            break;
                    }
                } catch (error) {
                    console.error("處理離線操作失敗:", op, error);
                    hasError = true;
                }
            }

            try {
                await batch.commit();
                offlineOperations = [];
                localStorage.removeItem("offlineOperations");
                updateOfflineOperationsCount(0);
                showToast("所有離線變更已成功同步！", "success");
            } catch (error) {
                console.error("提交離線操作批次失敗:", error);
                showToast("離線變更同步失敗，請重試。", "error");
                hasError = true;
            } finally {
                isSyncing = false;
                if (hasError) {
                    showToast("部分離線變更同步失敗，請檢查控制台。", "error");
                }
            }
        }

        // ==================== 書籍操作 ====================

        async function getBooks() {
            const booksCollectionRef = collection(db, `users/${FIXED_USER_ID}/books`);
            const q = query(booksCollectionRef, orderBy("createdAt", "desc"));
            return new Promise((resolve) => {
                onSnapshot(q, (snapshot) => {
                    const books = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date(),
                        updatedAt: doc.data().updatedAt ? doc.data().updatedAt.toDate() : new Date()
                    }));
                    allBooks = books;
                    renderBooks();
                    updateStats();
                    resolve(books);
                }, (error) => {
                    console.error("監聽書籍變化失敗:", error);
                    showToast("書籍資料同步失敗，請檢查網路或重新整理。", "error");
                    resolve([]);
                });
            });
        }

        async function addBook(bookData) {
            try {
                const booksCollectionRef = collection(db, `users/${FIXED_USER_ID}/books`);
                const docRef = await addDoc(booksCollectionRef, { ...bookData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showToast("書籍新增成功！", "success");
            } catch (e) {
                console.error("新增書籍失敗: ", e);
                showToast("新增書籍失敗！", "error");
                addOfflineOperation({ type: "add", collection: "books", id: Date.now().toString(), data: { ...bookData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() } });
            }
        }

        async function updateBook(bookId, updateData) {
            try {
                const bookRef = doc(db, `users/${FIXED_USER_ID}/books`, bookId);
                await updateDoc(bookRef, { ...updateData, updatedAt: serverTimestamp() });
                showToast("書籍更新成功！", "success");
            } catch (e) {
                console.error("更新書籍失敗: ", e);
                showToast("更新書籍失敗！", "error");
                addOfflineOperation({ type: "update", collection: "books", id: bookId, data: { ...updateData, updatedAt: serverTimestamp() } });
            }
        }

        async function deleteBook(bookId) {
            try {
                await deleteDoc(doc(db, `users/${FIXED_USER_ID}/books`, bookId));
                showToast("書籍刪除成功！", "success");
            } catch (e) {
                console.error("刪除書籍失敗: ", e);
                showToast("刪除書籍失敗！", "error");
                addOfflineOperation({ type: "delete", collection: "books", id: bookId });
            }
        }

        // ==================== 分類操作 (階層化) ====================

        async function getCategories() {
            const categoriesCollectionRef = collection(db, `users/${FIXED_USER_ID}/categories`);
            const q = query(categoriesCollectionRef, orderBy("name", "asc"));
            return new Promise((resolve) => {
                onSnapshot(q, (snapshot) => {
                    const categories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    allCategories = categories;
                    renderCategoriesSidebar();
                    populateCategorySelect();
                    updateStats();
                    resolve(categories);
                }, (error) => {
                    console.error("監聽分類變化失敗:", error);
                    showToast("分類資料同步失敗，請檢查網路或重新整理。", "error");
                    resolve([]);
                });
            });
        }

        async function addCategory(categoryData) {
            try {
                const categoriesCollectionRef = collection(db, `users/${FIXED_USER_ID}/categories`);
                await addDoc(categoriesCollectionRef, categoryData);
                showToast("分類新增成功！", "success");
            } catch (e) {
                console.error("新增分類失敗: ", e);
                showToast("新增分類失敗！", "error");
                addOfflineOperation({ type: "add", collection: "categories", id: Date.now().toString(), data: categoryData });
            }
        }

        async function updateCategory(categoryId, updateData) {
            try {
                const categoryRef = doc(db, `users/${FIXED_USER_ID}/categories`, categoryId);
                await updateDoc(categoryRef, updateData);
                showToast("分類更新成功！", "success");
            } catch (e) {
                console.error("更新分類失敗: ", e);
                showToast("更新分類失敗！", "error");
                addOfflineOperation({ type: "update", collection: "categories", id: categoryId, data: updateData });
            }
        }

        async function deleteCategory(categoryId) {
            try {
                // 獲取所有子分類ID
                const allSubCategoryIds = getAllSubCategoryIds(allCategories, categoryId);
                const allCategoryIdsToDelete = [categoryId, ...allSubCategoryIds];

                // 批量更新相關書籍的分類為 "uncategorized"
                const batch = writeBatch(db);
                const booksToUpdate = allBooks.filter(book => allCategoryIdsToDelete.includes(book.category));
                booksToUpdate.forEach(book => {
                    const bookRef = doc(db, `users/${FIXED_USER_ID}/books`, book.id);
                    batch.update(bookRef, { category: "uncategorized" });
                });

                // 批量刪除分類
                allCategoryIdsToDelete.forEach(id => {
                    const categoryRef = doc(db, `users/${FIXED_USER_ID}/categories`, id);
                    batch.delete(categoryRef);
                });

                await batch.commit();
                showToast("分類及其相關書籍已更新！", "success");
            } catch (e) {
                console.error("刪除分類失敗: ", e);
                showToast("刪除分類失敗！", "error");
                addOfflineOperation({ type: "delete", collection: "categories", id: categoryId });
            }
        }

        // ==================== 渲染函數 ====================

        function renderBooks() {
            hideLoading();
            const searchTerm = searchInput.value.toLowerCase();
            let filteredBooks = allBooks;

            if (currentFilterCategory) {
                const categoryPath = allCategories.find(cat => cat.id === currentFilterCategory)?.path;
                if (categoryPath) {
                    const childCategoryIds = getChildCategoryIdsRecursive(allCategories, currentFilterCategory);
                    filteredBooks = filteredBooks.filter(book => 
                        book.category === currentFilterCategory || childCategoryIds.includes(book.category)
                    );
                }
            }

            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book =>
                    book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm) ||
                    (book.description && book.description.toLowerCase().includes(searchTerm))
                );
            }

            // 排序
            filteredBooks.sort((a, b) => {
                switch (currentSortOrder) {
                    case "title-asc": return a.title.localeCompare(b.title);
                    case "title-desc": return b.title.localeCompare(a.title);
                    case "author-asc": return a.author.localeCompare(b.author);
                    case "author-desc": return b.author.localeCompare(a.author);
                    case "category-asc": 
                        const catA = allCategories.find(cat => cat.id === a.category)?.name || "";
                        const catB = allCategories.find(cat => cat.id === b.category)?.name || "";
                        return catA.localeCompare(catB);
                    case "category-desc":
                        const catADesc = allCategories.find(cat => cat.id === a.category)?.name || "";
                        const catBDesc = allCategories.find(cat => cat.id === b.category)?.name || "";
                        return catBDesc.localeCompare(catADesc);
                    case "date-desc": return b.createdAt - a.createdAt;
                    default: return 0;
                }
            });

            booksContainer.innerHTML = "";
            if (filteredBooks.length === 0) {
                showEmptyState();
                return;
            }
            hideEmptyState();

            filteredBooks.forEach(book => {
                const bookCard = document.createElement("div");
                bookCard.className = `book-card bg-white rounded-lg shadow-md p-4 flex flex-col ${currentViewMode === "list" ? "md:flex-row" : ""}`;
                bookCard.innerHTML = `
                    <img src="${book.cover || "https://via.placeholder.com/128x192?text=No+Cover"}" alt="${book.title}" class="w-full h-48 object-cover rounded-md mb-4 ${currentViewMode === "list" ? "md:w-32 md:h-48 md:mr-4 md:mb-0" : ""}">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">${book.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">${book.author}</p>
                        <p class="text-gray-500 text-xs mb-2">分類: ${getCategoryPath(book.category)}</p>
                        <p class="text-gray-700 text-sm mb-4 line-clamp-3">${book.description || "無描述"}</p>
                        <div class="flex space-x-2">
                            <button class="edit-book-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600" data-id="${book.id}">編輯</button>
                            <button class="delete-book-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" data-id="${book.id}">刪除</button>
                        </div>
                    </div>
                `;
                booksContainer.appendChild(bookCard);
            });

            document.querySelectorAll(".edit-book-btn").forEach(button => {
                button.addEventListener("click", (e) => openEditBookModal(e.target.dataset.id));
            });
            document.querySelectorAll(".delete-book-btn").forEach(button => {
                button.addEventListener("click", (e) => {
                    if (confirm("確定要刪除這本書嗎？")) {
                        deleteBook(e.target.dataset.id);
                    }
                });
            });
        }

        function renderCategoriesSidebar() {
            categoriesList.innerHTML = "";
            const rootCategories = allCategories.filter(cat => !cat.parentId);
            rootCategories.forEach(category => {
                categoriesList.appendChild(createCategoryListItem(category));
            });
        }

        function createCategoryListItem(category) {
            const li = document.createElement("li");
            li.className = "mb-1";
            const hasChildren = allCategories.some(cat => cat.parentId === category.id);

            li.innerHTML = `
                <div class="flex items-center group cursor-pointer hover:bg-gray-100 p-2 rounded-md category-item" data-id="${category.id}">
                    ${hasChildren ? `<i class="fas fa-chevron-right text-gray-400 mr-2 category-toggle" data-id="${category.id}"></i>` : `<i class="fas fa-circle text-gray-400 text-xs mr-3"></i>`}
                    <span class="flex-grow category-filter" data-id="${category.id}">${category.name}</span>
                </div>
                <ul class="category-children hidden" data-parent-id="${category.id}"></ul>
            `;

            const categoryItem = li.querySelector(".category-item");
            const toggleIcon = li.querySelector(".category-toggle");
            
            // 為整個分類項目添加點擊事件
            categoryItem.addEventListener("click", (e) => {
                e.stopPropagation();
                
                // 如果有子分類，則展開/收縮
                if (hasChildren) {
                    const childrenList = li.querySelector(".category-children");
                    childrenList.classList.toggle("hidden");
                    toggleIcon.classList.toggle("fa-chevron-right");
                    toggleIcon.classList.toggle("fa-chevron-down");
                }
                
                // 設置當前篩選分類
                currentFilterCategory = category.id;
                renderBooks();
            });

            // 遞歸渲染子分類
            const childrenList = li.querySelector(".category-children");
            const children = allCategories.filter(cat => cat.parentId === category.id);
            children.forEach(child => {
                childrenList.appendChild(createCategoryListItem(child));
            });

            return li;
        }

        function populateCategorySelect() {
            bookCategorySelect.innerHTML = 
                `<option value="uncategorized">未分類</option>` +
                allCategories.map(cat => `<option value="${cat.id}">${getCategoryPath(cat.id)}</option>`).join("");
        }

        function updateStats() {
            totalBooksSpan.textContent = allBooks.length;
        }

        // ==================== 模態框操作 ====================

        function openAddBookModal() {
            addBookModal.classList.remove("hidden");
            bookTitleInput.value = "";
            bookAuthorInput.value = "";
            bookCategorySelect.value = "uncategorized";
            bookCoverInput.value = "";
            saveBookBtn.dataset.mode = "add";
            saveBookText.textContent = "儲存書籍";
            saveBookSpinner.classList.add("hidden");
        }

        function closeAddBookModal() {
            addBookModal.classList.add("hidden");
        }

        async function openEditBookModal(bookId) {
            const book = allBooks.find(b => b.id === bookId);
            if (!book) return;

            bookTitleInput.value = book.title;
            bookAuthorInput.value = book.author;
            bookCategorySelect.value = book.category;
            bookCoverInput.value = book.cover;
            saveBookBtn.dataset.mode = "edit";
            saveBookBtn.dataset.id = bookId;
            saveBookText.textContent = "更新書籍";
            saveBookSpinner.classList.add("hidden");
            addBookModal.classList.remove("hidden");
        }

        function openAddByIsbnModal() {
            addByIsbnModal.classList.remove("hidden");
            isbnInput.value = "";
            isbnSearchResults.classList.add("hidden");
            addFoundBookBtn.classList.add("hidden");
            searchIsbnText.textContent = "搜尋";
            searchIsbnSpinner.classList.add("hidden");
        }

        function closeAddByIsbnModal() {
            addByIsbnModal.classList.add("hidden");
        }

        function openManageCategoriesModal() {
            manageCategoriesModal.classList.remove("hidden");
            renderManageCategoriesList();
        }

        function closeManageCategoriesModal() {
            manageCategoriesModal.classList.add("hidden");
        }

        function renderManageCategoriesList() {
            manageCategoriesList.innerHTML = "";
            const rootCategories = allCategories.filter(cat => !cat.parentId);
            rootCategories.forEach(category => {
                manageCategoriesList.appendChild(createManageCategoryListItem(category));
            });
        }

        function createManageCategoryListItem(category) {
            const li = document.createElement("li");
            li.className = "mb-1";
            const hasChildren = allCategories.some(cat => cat.parentId === category.id);

            li.innerHTML = `
                <div class="flex items-center justify-between group p-2 rounded-md hover:bg-gray-50">
                    <div class="flex items-center flex-grow">
                        ${hasChildren ? `<i class="fas fa-chevron-right text-gray-400 mr-2 category-toggle" data-id="${category.id}"></i>` : `<i class="fas fa-circle text-gray-400 text-xs mr-3"></i>`}
                        <span class="flex-grow">${category.name}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="add-sub-category-btn text-green-600 hover:text-green-800 text-sm" data-id="${category.id}" data-name="${category.name}">
                            <i class="fas fa-plus"></i> 子分類
                        </button>
                        <button class="edit-category-btn text-blue-600 hover:text-blue-800 text-sm" data-id="${category.id}" data-name="${category.name}">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                        <button class="delete-category-btn text-red-600 hover:text-red-800 text-sm" data-id="${category.id}">
                            <i class="fas fa-trash"></i> 刪除
                        </button>
                    </div>
                </div>
                <ul class="category-children hidden" data-parent-id="${category.id}"></ul>
            `;

            const toggleIcon = li.querySelector(".category-toggle");
            if (toggleIcon) {
                toggleIcon.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const childrenList = li.querySelector(".category-children");
                    childrenList.classList.toggle("hidden");
                    e.target.classList.toggle("fa-chevron-right");
                    e.target.classList.toggle("fa-chevron-down");
                });
            }

            li.querySelector(".add-sub-category-btn").addEventListener("click", (e) => {
                const parentId = e.target.dataset.id;
                const parentName = e.target.dataset.name;
                const subCategoryName = prompt(`請輸入 ${parentName} 的子分類名稱:`);
                if (subCategoryName) {
                    const parentCategory = allCategories.find(cat => cat.id === parentId);
                    const newLevel = parentCategory ? parentCategory.level + 1 : 1;
                    const newPath = parentCategory ? `${parentCategory.path}/${subCategoryName}` : `/${subCategoryName}`;
                    addCategory({ name: subCategoryName, parentId: parentId, level: newLevel, path: newPath });
                }
            });

            li.querySelector(".edit-category-btn").addEventListener("click", (e) => {
                const categoryId = e.target.dataset.id;
                const oldName = e.target.dataset.name;
                const newName = prompt(`編輯分類名稱:`, oldName);
                if (newName && newName !== oldName) {
                    updateCategory(categoryId, { name: newName });
                }
            });

            li.querySelector(".delete-category-btn").addEventListener("click", (e) => {
                const categoryId = e.target.dataset.id;
                if (confirm("確定要刪除此分類及其所有子分類和相關書籍嗎？相關書籍將被設為未分類。")) {
                    deleteCategory(categoryId);
                }
            });

            // 遞歸渲染子分類
            const childrenList = li.querySelector(".category-children");
            const children = allCategories.filter(cat => cat.parentId === category.id);
            children.forEach(child => {
                childrenList.appendChild(createManageCategoryListItem(child));
            });

            return li;
        }

        // ==================== 工具函數 ====================

        function getCategoryPath(categoryId) {
            if (categoryId === "uncategorized") return "未分類";
            const category = allCategories.find(cat => cat.id === categoryId);
            if (!category) return "未知分類";

            let path = category.name;
            let current = category;
            while (current.parentId) {
                const parent = allCategories.find(cat => cat.id === current.parentId);
                if (parent) {
                    path = `${parent.name} / ${path}`;
                    current = parent;
                } else {
                    break;
                }
            }
            return path;
        }

        function getAllSubCategoryIds(categories, parentId) {
            const subCategoryIds = [];
            categories.forEach(category => {
                if (category.parentId === parentId) {
                    subCategoryIds.push(category.id);
                    subCategoryIds.push(...getAllSubCategoryIds(categories, category.id));
                }
            });
            return subCategoryIds;
        }

        function getChildCategoryIdsRecursive(categories, parentId) {
            const children = categories.filter(cat => cat.parentId === parentId);
            let ids = children.map(c => c.id);
            children.forEach(c => {
                ids = ids.concat(getChildCategoryIdsRecursive(categories, c.id));
            });
            return ids;
        }

        async function searchBookByIsbn(isbn) {
            // 優先使用 Google Books API
            if (GOOGLE_BOOKS_API_KEY) {
                try {
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&key=${GOOGLE_BOOKS_API_KEY}`);
                    const data = await response.json();
                    if (data.items && data.items.length > 0) {
                        const item = data.items[0].volumeInfo;
                        return {
                            title: item.title,
                            author: item.authors ? item.authors.join(", ") : "未知作者",
                            cover: item.imageLinks ? item.imageLinks.thumbnail : "",
                            description: item.description || ""
                        };
                    }
                } catch (error) {
                    console.error("Google Books API 搜尋失敗:", error);
                }
            }

            // 備用 Open Library API
            try {
                const response = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
                const data = await response.json();
                if (data) {
                    const title = data.title || "";
                    const authors = data.authors ? await Promise.all(data.authors.map(async (author) => {
                        const authorRes = await fetch(`https://openlibrary.org${author.key}.json`);
                        const authorData = await authorRes.json();
                        return authorData.name;
                    })) : [];
                    const cover = data.covers ? `https://covers.openlibrary.org/b/id/${data.covers[0]}-L.jpg` : "";
                    const description = typeof data.description === "string" ? data.description : data.description?.value || "";

                    return {
                        title: title,
                        author: authors.join(", "),
                        cover: cover,
                        description: description
                    };
                }
            } catch (error) {
                console.error("Open Library API 搜尋失敗:", error);
            }

            return null;
        }

        // ==================== 事件監聽器 ====================

        // 頁面載入完成後初始化
        document.addEventListener("DOMContentLoaded", () => {
            console.log("開始初始化應用程式...");
            
            // 直接開始載入資料，不需要 Authentication
            getBooks(); // 開始監聽書籍變化
            getCategories(); // 開始監聽分類變化

            // 監聽網路連線狀態
            window.addEventListener("online", () => {
                toggleOfflineIndicator(false);
                showToast("網路已連線，嘗試同步資料...", "info");
                syncOfflineOperations();
            });

            window.addEventListener("offline", () => {
                toggleOfflineIndicator(true);
                showToast("網路已離線，變更將在重新連線後同步。", "error");
            });

            // 初始檢查網路狀態
            if (!navigator.onLine) {
                toggleOfflineIndicator(true);
                showToast("網路已離線，變更將在重新連線後同步。", "error");
            }

            // 綁定事件
            addBookBtn.addEventListener("click", openAddBookModal);
            closeModalBtn.addEventListener("click", closeAddBookModal);
            cancelAddBookBtn.addEventListener("click", closeAddBookModal);

            addBookForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                saveBookSpinner.classList.remove("hidden");
                saveBookText.textContent = "儲存中...";

                const bookData = {
                    title: bookTitleInput.value,
                    author: bookAuthorInput.value,
                    category: bookCategorySelect.value,
                    cover: bookCoverInput.value,
                    description: ""
                };

                if (saveBookBtn.dataset.mode === "add") {
                    await addBook(bookData);
                } else {
                    await updateBook(saveBookBtn.dataset.id, bookData);
                }
                saveBookSpinner.classList.add("hidden");
                saveBookText.textContent = "儲存書籍";
                closeAddBookModal();
            });

            addByIsbnBtn.addEventListener("click", openAddByIsbnModal);
            closeIsbnModalBtn.addEventListener("click", closeAddByIsbnModal);
            cancelIsbnSearchBtn.addEventListener("click", closeAddByIsbnModal);

            searchIsbnBtn.addEventListener("click", async () => {
                const isbn = isbnInput.value.trim();
                if (!isbn) {
                    showToast("請輸入 ISBN 號碼！", "error");
                    return;
                }

                searchIsbnSpinner.classList.remove("hidden");
                searchIsbnText.textContent = "搜尋中...";
                isbnSearchResults.classList.add("hidden");
                addFoundBookBtn.classList.add("hidden");

                const book = await searchBookByIsbn(isbn);

                searchIsbnSpinner.classList.add("hidden");
                searchIsbnText.textContent = "搜尋";

                if (book) {
                    isbnBookCover.src = book.cover || "https://via.placeholder.com/128x192?text=No+Cover";
                    isbnBookTitle.textContent = book.title;
                    isbnBookAuthor.textContent = book.author;
                    isbnBookCategory.textContent = ""; // 分類在新增時選擇
                    isbnSearchResults.classList.remove("hidden");
                    addFoundBookBtn.classList.remove("hidden");
                    addFoundBookBtn.dataset.book = JSON.stringify(book);
                } else {
                    showToast("未找到該 ISBN 的書籍資訊。", "error");
                }
            });

            addFoundBookBtn.addEventListener("click", async (e) => {
                const bookData = JSON.parse(e.target.dataset.book);
                await addBook({ ...bookData, category: "uncategorized" });
                closeAddByIsbnModal();
            });

            manageCategoriesBtn.addEventListener("click", openManageCategoriesModal);
            closeManageCategoriesModalBtn.addEventListener("click", closeManageCategoriesModal);
            saveCategoriesBtn.addEventListener("click", closeManageCategoriesModal);

            addCategoryBtn.addEventListener("click", () => {
                const categoryName = newCategoryNameInput.value.trim();
                if (categoryName) {
                    addCategory({ name: categoryName, parentId: null, level: 0, path: `/${categoryName}` });
                    newCategoryNameInput.value = "";
                } else {
                    showToast("分類名稱不能為空！", "error");
                }
            });

            searchInput.addEventListener("input", renderBooks);
            sortSelect.addEventListener("change", (e) => {
                currentSortOrder = e.target.value;
                renderBooks();
            });

            gridViewBtn.addEventListener("click", () => {
                currentViewMode = "grid";
                gridViewBtn.classList.add("bg-indigo-100", "text-indigo-600");
                listViewBtn.classList.remove("bg-indigo-100", "text-indigo-600");
                renderBooks();
            });

            listViewBtn.addEventListener("click", () => {
                currentViewMode = "list";
                listViewBtn.classList.add("bg-indigo-100", "text-indigo-600");
                gridViewBtn.classList.remove("bg-indigo-100", "text-indigo-600");
                renderBooks();
            });
        });

        // 全域函數，供 HTML 中的 onclick 使用
        window.openAddBookModal = openAddBookModal;
    </script>
</body>
</html>

